# .github/workflows/auto-post-note.yml
name: ğŸš€ Note.comè‡ªå‹•æŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    # ä¸­3æ—¥å®Ÿè¡Œï¼ˆæœˆæ›œãƒ»æœ¨æ›œã®æœ8æ™‚JSTï¼‰
    - cron: "59 22 * * 1,4" # UTC 22:59 = JST 7:59 â†’ JST 8:00
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# åŒæ™‚å®Ÿè¡Œé˜²æ­¢ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå¯¾ç­–ï¼‰
concurrency:
  group: note-auto-post
  cancel-in-progress: false # å®Ÿè¡Œä¸­ã®ã‚¸ãƒ§ãƒ–ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„

jobs:
  auto-post-note:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      - name: ğŸ“ è¨˜äº‹ç”Ÿæˆï¼ˆPeaky Media RSSï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ• $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST') - è¨˜äº‹ç”Ÿæˆé–‹å§‹"
          python create.py
          echo "âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†"

      - name: ğŸ“„ ç”Ÿæˆè¨˜äº‹ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆï¼ˆå®‰å…¨ç‰ˆï¼‰
        run: |
          # Gitè¨­å®š
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          # æœ€æ–°ã®ãƒªãƒ¢ãƒ¼ãƒˆçŠ¶æ…‹ã‚’å–å¾—ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå›é¿ï¼‰
          echo "ğŸ”„ æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ä¸­..."
          git fetch origin main

          # ãƒªãƒ¢ãƒ¼ãƒˆã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯rebase
          if ! git diff --quiet HEAD origin/main; then
            echo "ğŸ”„ ãƒªãƒ¢ãƒ¼ãƒˆã«æ–°ã—ã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚rebaseå®Ÿè¡Œä¸­..."
            git rebase origin/main || {
              echo "âŒ rebaseã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®‰å…¨ã®ãŸã‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™"
              git rebase --abort
              exit 1
            }
          fi

          # ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          TODAY=$(TZ='Asia/Tokyo' date +'%Y%m%d')
          ARTICLE_FILE="articles/${TODAY}.md"

          if [ -f "$ARTICLE_FILE" ]; then
            echo "ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹: $ARTICLE_FILE"
            echo "ğŸ“Š è¨˜äº‹ã‚µã‚¤ã‚º: $(wc -c < "$ARTICLE_FILE") bytes"
            
            # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if git ls-files --error-unmatch "$ARTICLE_FILE" >/dev/null 2>&1; then
              echo "âš ï¸ æ—¢å­˜ã®è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
              
              # å†…å®¹ãŒåŒã˜ã‹ãƒã‚§ãƒƒã‚¯
              if git diff --quiet "$ARTICLE_FILE"; then
                echo "ğŸ“ è¨˜äº‹å†…å®¹ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
                exit 0
              else
                echo "âœï¸ è¨˜äº‹å†…å®¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚ä¸Šæ›¸ãã—ã¾ã™"
              fi
            else
              echo "ğŸ†• æ–°ã—ã„è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"
            fi
            
            # è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
            TITLE=$(grep '^# ' "$ARTICLE_FILE" | head -1 | sed 's/^# //' | cut -c1-50)
            
            # Gitã«è¿½åŠ 
            git add "$ARTICLE_FILE"
            
            # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if git diff --staged --quiet; then
              echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            else
              # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œï¼ˆå®‰å…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ï¼‰
              git commit -m "Auto-generated article: ${TODAY}" \
                         -m "Title: ${TITLE}..." \
                         -m "Generated: $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST')" \
                         -m "Size: $(wc -c < '$ARTICLE_FILE') bytes"
              
              echo "âœ… è¨˜äº‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
            fi
          else
            echo "âŒ è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ« $ARTICLE_FILE ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: â³ ç”Ÿæˆå®Œäº†å¾…æ©Ÿ
        run: |
          echo "ğŸ“ è¨˜äº‹ç”Ÿæˆå¾Œã®å¾…æ©Ÿæ™‚é–“..."
          sleep 30

      - name: ğŸš€ Note.comè‡ªå‹•æŠ•ç¨¿
        env:
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          HEADLESS: "true"
        run: |
          echo "ğŸ• $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST') - æŠ•ç¨¿é–‹å§‹"
          python main.py
          echo "âœ… æŠ•ç¨¿å®Œäº†"

      - name: ğŸ“¤ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆå®‰å…¨ç‰ˆãƒ»ãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
        run: |
          # ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if ! git log origin/main..HEAD --oneline | grep -q .; then
            echo "ğŸ“ ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          echo "ğŸ“¤ è¨˜äº‹ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."

          # ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ããƒ—ãƒƒã‚·ãƒ¥ï¼ˆæœ€å¤§3å›ï¼‰
          MAX_RETRY=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
            echo "ğŸš€ ãƒ—ãƒƒã‚·ãƒ¥è©¦è¡Œ $((RETRY_COUNT + 1))/$MAX_RETRY"
            
            if git push origin main; then
              echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥æˆåŠŸï¼"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRY ]; then
                echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ã€‚ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãƒªãƒˆãƒ©ã‚¤..."
                
                # ãƒªãƒ¢ãƒ¼ãƒˆã®æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—
                git fetch origin main
                
                # ãƒªãƒ™ãƒ¼ã‚¹è©¦è¡Œ
                if git rebase origin/main; then
                  echo "ğŸ”„ ãƒªãƒ™ãƒ¼ã‚¹æˆåŠŸã€‚å†åº¦ãƒ—ãƒƒã‚·ãƒ¥è©¦è¡Œã—ã¾ã™"
                  sleep 5  # å°‘ã—å¾…æ©Ÿ
                else
                  echo "âŒ ãƒªãƒ™ãƒ¼ã‚¹å¤±æ•—ã€‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™"
                  git rebase --abort
                  exit 1
                fi
              else
                echo "âŒ æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã«é”ã—ã¾ã—ãŸã€‚ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—"
                exit 1
              fi
            fi
          done

      - name: ğŸ“¸ ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: "*.png"
          retention-days: 3
