# .github/workflows/auto-post-note.yml
name: ğŸš€ Note.comè‡ªå‹•æŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    # ä¸­3æ—¥å®Ÿè¡Œï¼ˆæœˆæ›œãƒ»æœ¨æ›œã®æœ8æ™‚JSTï¼‰
    - cron: "59 22 * * 0,3" # UTC 22:59 = JST 7:59 â†’ JST 8:00ã«å®Ÿè¡Œ
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  auto-post-note:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      - name: ğŸ“ è¨˜äº‹ç”Ÿæˆï¼ˆPeaky Media RSSï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ• $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST') - è¨˜äº‹ç”Ÿæˆé–‹å§‹"
          python create.py
          echo "âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†"

      - name: â³ ç”Ÿæˆå®Œäº†å¾…æ©Ÿ
        run: |
          echo "ğŸ“ è¨˜äº‹ç”Ÿæˆå¾Œã®å¾…æ©Ÿæ™‚é–“..."
          sleep 30

      - name: ğŸš€ Note.comè‡ªå‹•æŠ•ç¨¿
        env:
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          HEADLESS: "true"
        run: |
          echo "ğŸ• $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST') - æŠ•ç¨¿é–‹å§‹"
          python main.py
          echo "âœ… æŠ•ç¨¿å®Œäº†"

      - name: ğŸ“¸ ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: "*.png"
          retention-days: 3
