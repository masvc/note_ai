# .github/workflows/auto-post-note.yml
name: ğŸš€ Note.comè‡ªå‹•æŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    # æœˆæ›œãƒ»æœ¨æ›œã®æœ8æ™‚JST = æ—¥æ›œãƒ»æ°´æ›œã®23æ™‚UTC
    - cron: "0 23 * * 0,3"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# åŒæ™‚å®Ÿè¡Œé˜²æ­¢
concurrency:
  group: note-auto-post
  cancel-in-progress: false

jobs:
  auto-post-note:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      - name: ğŸ“ è¨˜äº‹ç”Ÿæˆï¼ˆPeaky Media RSSï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TZ: Asia/Tokyo # ğŸ‘ˆ JSTæ™‚é–“ã‚’å¼·åˆ¶è¨­å®šï¼ˆæ—¥ä»˜ä¸æ•´åˆå¯¾ç­–ï¼‰
        run: |
          echo "ğŸ• $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST') - è¨˜äº‹ç”Ÿæˆé–‹å§‹"
          python create.py
          echo "âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†"

      - name: ğŸš€ Note.comè‡ªå‹•æŠ•ç¨¿
        env:
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          HEADLESS: "true"
        run: |
          echo "ğŸ• $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST') - æŠ•ç¨¿é–‹å§‹"
          python main.py
          echo "âœ… æŠ•ç¨¿å®Œäº†"

      - name: ğŸ“„ è¨˜äº‹ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ï¼ˆã‚¨ãƒ©ãƒ¼è€æ€§ç‰ˆï¼‰
        run: |
          # Gitè¨­å®š
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          echo "ğŸ“ è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªä¸­..."

          # å®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ï¼ˆæ—¥ä»˜ä¸æ•´åˆå¯¾å¿œï¼‰
          ARTICLE_FILE=$(find articles/ -name "*.md" -type f | sort | tail -1)

          if [ -n "$ARTICLE_FILE" ] && [ -f "$ARTICLE_FILE" ]; then
            echo "ğŸ“„ è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: $ARTICLE_FILE"
            echo "ğŸ“Š è¨˜äº‹ã‚µã‚¤ã‚º: $(wc -c < "$ARTICLE_FILE") bytes"
            
            # è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡º
            TITLE=$(grep '^# ' "$ARTICLE_FILE" | head -1 | sed 's/^# //' | cut -c1-50 || echo "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«")
            
            # Gitå‡¦ç†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
            git add "$ARTICLE_FILE" || echo "âš ï¸ Git addå¤±æ•—ï¼ˆç¶šè¡Œï¼‰"
            
            # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! git diff --staged --quiet 2>/dev/null; then
              echo "ğŸ“ æ–°ã—ã„è¨˜äº‹ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
              
              # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
              COMMIT_DATE=$(TZ='Asia/Tokyo' date +'%Y%m%d')
              git commit -m "Auto-generated article: ${COMMIT_DATE}" \
                         -m "Title: ${TITLE}..." \
                         -m "Generated: $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST')" || echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆå¤±æ•—ï¼ˆç¶šè¡Œï¼‰"
              
              # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
              echo "ğŸ“¤ è¨˜äº‹ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
              if git push origin main 2>/dev/null; then
                echo "âœ… è¨˜äº‹ä¿å­˜å®Œäº†"
              else
                echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆè¨˜äº‹æŠ•ç¨¿ã¯æˆåŠŸæ¸ˆã¿ï¼‰"
                # ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ãƒªãƒˆãƒ©ã‚¤
                git fetch origin main 2>/dev/null || true
                if git rebase origin/main 2>/dev/null; then
                  git push origin main 2>/dev/null && echo "âœ… ãƒªãƒˆãƒ©ã‚¤æˆåŠŸ" || echo "âš ï¸ æœ€çµ‚ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—"
                else
                  echo "âš ï¸ ãƒªãƒ™ãƒ¼ã‚¹å¤±æ•—ï¼ˆè¨˜äº‹æŠ•ç¨¿ã¯æˆåŠŸæ¸ˆã¿ï¼‰"
                  git rebase --abort 2>/dev/null || true
                fi
              fi
            else
              echo "ğŸ“ æ–°ã—ã„å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            fi
          else
            echo "âš ï¸ è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ãŒã€æŠ•ç¨¿ã¯å®Œäº†æ¸ˆã¿"
            ls -la articles/ || echo "ğŸ“ articlesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi

          echo "ğŸ‰ å…¨å‡¦ç†å®Œäº†ï¼"

      - name: ğŸ“¸ ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots-${{ github.run_number }}
          path: "*.png"
          retention-days: 3

      - name: ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "ğŸ• å®Œäº†æ™‚åˆ»: $(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S JST')"
          echo "ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          ls -la articles/ 2>/dev/null || echo "ğŸ“‚ articlesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
          echo "ğŸ¯ Note.comæŠ•ç¨¿: å®Œäº†"
          echo "ğŸ“„ è¨˜äº‹ä¿å­˜: $([ -n "$(find articles/ -name "*.md" -type f 2>/dev/null)" ] && echo "å®Œäº†" || echo "ã‚¹ã‚­ãƒƒãƒ—")"
